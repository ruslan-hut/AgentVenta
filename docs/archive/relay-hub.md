# Relay Hub Server Architecture

## Overview

Приложение будет выполнять роль Relay сервера - получать данные из учетной системы и передавать на Android приложение.

- Для получения данных будет реализован API, куда будут поступать запросы с данными
- Для передачи на телефон будет использоваться канал WebSocket

## Основная логика работы

Полученные данные кладутся в БД, каждая запись содержит идентификатор получателя. Телефон устанавливает канал WebSocket, по его идентификатору берем данные из очереди и отправляем на устройство.

**Важно:** сервер один обслуживает несколько учетных систем, каждая система общается только со своим набором телефонов, системы изолированы друг от друга. Разграничение по номеру лицензии (см. раздел "Идентификация").

## База данных

**БД:** NoSQL, MongoDB

Данные получаем в виде JSON объектов и храним в очереди в виде объектов:

```json
{
  "id": "device_uuid",
  "data": {},
  "time": "timestamp",
  "ready": false
}
```

**Логика обработки:**
- При получении данных: `ready=false`
- Когда данные получены и передача успешно завершена: `ready=true`
- Пул соединений с телефонами проверяет очередь на наличие записей с `id` телефона (привязан к сокету) и `ready=true`
- Вычитывает данные в очередности `time` и отправляет на телефон
- После того как данные приняты телефоном, удаляем из БД, из очереди

**Итого:** на сервере данные лежат от приема до отправки на телефон.

## Обратная передача данных

Телефон присылает данные для передачи и они кладутся в очередь. Учетная система запрашивает данные и мы отдаем ей записи от всех телефонов, которые относятся к этой учетной системе.

## Идентификация

- **UUID** (сгенерированный на телефоне) идентифицирует соединение телефона
- **Номер лицензии** идентифицирует учетную систему
- К номеру лицензии привязаны UUID телефонов

Таким образом определяем, кто какие данные получает и кому передает при обменах.

## Авторизация

### WebSocket соединение (Android приложение)

В приложение будет зашит **API ключ**, который мы будем проверять при установке соединения через WebSocket.

### API запросы (учетная система)

Запросы из учетной системы будут авторизоваться по **токену** (Bearer Token), который мы будем генерировать и хранить у себя вместе с номером лицензии.

## Постоянное хранилище данных

В БД на сервере хранятся постоянно:

- **Лицензии** с привязкой UUID телефонов и параметрами самой лицензии:
  - Срок действия
  - Ограничение на количество клиентов
  - Token
  - И другие параметры

- **Настройки с телефонов**, которые синхронизируются в обе стороны
  - Можно восстановить настройки на телефоне
  - Для этого в телефоне будет добавлена авторизация через Google аккаунт

## Управление соединениями

### На телефоне

WebSocket нужно поднимать как только:
- Приложение активно
- Есть соединение с Интернет

### На сервере

Пул соединений:
- Мониторит очередь
- Отправляет данные
- Принимает новые данные и кладет в очередь
